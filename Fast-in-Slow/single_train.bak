#!/bin/bash

# parameter
export PYTHONPATH=/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow:/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow/timm:$PYTHONPATH
# export HF_HOME=/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/.cache/huggingface

export CUDA_VISIBLE_DEVICES=1

USE_UAV_DATASET=true

TRAINING_MODE='async'        # a very powerful control mode, see "models/vlms/prismatic.py"
LLM_MIDDLE_LAYER=30
FUTURE_ACTION_STEPS=0
LOAD_POINTCLOUD=false
LOAD_STATE=true
POINTCLOUD_POS='fast'        # use when LOAD_POINTCLOUD is true
DIFFUSION_STEPS=100
ACTION_TOKENIZER_EXIST=true  # if you dont want to use AR loss, set it to false
USE_DIFF=true
AR_DIFF_LOSS=true            # if you dont want to use AR loss, set it to false
REPEATED_DIFFUSION_STEPS=4
CLASS_DROPOUT_PROB=0.0
FREEZE_VISON=true
FREEZE_LLM=true
SLOW_FAST_RATIO=1_4
ACTION_CHUNK=1
LANG_SUBGOALS_EXIST=true

SETTING="test_multi_key_STATE_${LOAD_STATE}_ACTION_CHUNK_${ACTION_CHUNK}_SLOW_FAST_RATIO_${SLOW_FAST_RATIO}_ddim${DIFFUSION_STEPS}_PC${LOAD_POINTCLOUD}_POS${POINTCLOUD_POS}_${TRAINING_MODE}_withARloss${LOAD_POINTCLOUD}_slow_fast_[after]_[-1]_${LLM_MIDDLE_LAYER}_fisvla_pretrain_window${FUTURE_ACTION_STEPS}"

DATA_MIX=uav_dataset
TASK=uav_dataset
BATCH_SIZE=1
EPOCHS=1
LEARNING_RATE=2e-5
ACTION_DIM=6
CAMERA_VIEW="head_slow,head_fast"

DATA_ROOT="/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/datasets/rlds_data"
EXP_ROOT=/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow/exp
MODEL_SAVE_NUM=3

NUM_GPUS=1
NODES=1


# 移除了 --vla.expected_world_size 参数
# 创建日志目录
LOG_DIR="/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow/logs"
mkdir -p ${LOG_DIR}

# 生成简洁的日志文件名
# 包含关键参数：任务、状态、点云、扩散步骤、时间戳
LOG_FILE="${LOG_DIR}/train_${TASK}_STATE${LOAD_STATE}_PC${LOAD_POINTCLOUD}_ddim${DIFFUSION_STEPS}_$(date '+%m%d_%H%M').log"

echo "训练日志将保存到: ${LOG_FILE}"
echo "开始训练..."

# 执行训练命令并将输出重定向到日志文件
python scripts/single_train.py \
  --vla.type prism-dinosiglip-224px+oxe+diffusion \
  --vla.data_mix ${DATA_MIX} \
  --vla.base_vlm prism-dinosiglip-224px+7b \
  --need_to_sub 0 \
  --vla.per_device_batch_size ${BATCH_SIZE} \
  --vla.global_batch_size $((${NUM_GPUS} * ${NODES} * ${BATCH_SIZE})) \
  --vla.learning_rate ${LEARNING_RATE} \
  --vla.epochs ${EPOCHS} \
  --vla.freeze_vision_backbone ${FREEZE_VISON} \
  --vla.freeze_llm_backbone ${FREEZE_LLM} \
  --data_root_dir ${DATA_ROOT} \
  --run_root_dir ${EXP_ROOT} \
  --run_id exp_${TASK}_${SETTING} \
  --image_aug false \
  --wandb_project 'vln_proj' \
  --wandb_entity 'vln_soolab_zhaoyang' \
  --save_interval 100 \
  --action_dim ${ACTION_DIM} \
  --repeated_diffusion_steps ${REPEATED_DIFFUSION_STEPS} \
  --action_tokenizer_exist ${ACTION_TOKENIZER_EXIST} \
  --future_action_window_size ${FUTURE_ACTION_STEPS} \
  --class_dropout_prob ${CLASS_DROPOUT_PROB} \
  --use_diff ${USE_DIFF} \
  --ar_diff_loss ${AR_DIFF_LOSS} \
  --is_resume False \
  --llm_middle_layer ${LLM_MIDDLE_LAYER} \
  --camera_view ${CAMERA_VIEW} \
  --training_mode ${TRAINING_MODE} \
  --load_pointcloud ${LOAD_POINTCLOUD} \
  --diffusion_steps ${DIFFUSION_STEPS} \
  --model_save_num ${MODEL_SAVE_NUM} \
  --pointcloud_pos ${POINTCLOUD_POS} \
  --action_chunk ${ACTION_CHUNK} \
  --load_state ${LOAD_STATE} \
  --lang_subgoals_exist ${LANG_SUBGOALS_EXIST} \
  --pretrained_checkpoint "/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/ckpt/fis/models--haosad--fisvla/snapshots/d5f66f3accd4c043742cfe348431f58c5609e950/fisvla_pretrain.pt" 2>&1 | tee -a ${LOG_FILE}

echo "训练完成！日志文件: ${LOG_FILE}"


# 方法    结果   可训练参数
# full-finetune   oom  7,609,501,126
# finetune  oom  6,878,589,446
# align  error  0
# vla-sandwich-train    oom  1,335,612,870  
# vla-last-layer-train    oom  




# # parameter
# export PYTHONPATH=/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow:/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow/timm:$PYTHONPATH
# export HF_HOME=/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/.cache/huggingface
# export NCCL_DEBUG=INFO
# # export NCCL_SOCKET_IFNAME=eth
# export NCCL_P2P_LEVEL=NVL
# export NCCL_TIMEOUT=1800
# export CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,7

# # UAV特定参数
# USE_UAV_DATASET=true

# TRAINING_MODE='async'        # a very powerful control mode, see "models/vlms/prismatic.py"
# LLM_MIDDLE_LAYER=30
# FUTURE_ACTION_STEPS=0
# LOAD_POINTCLOUD=false
# LOAD_STATE=true
# POINTCLOUD_POS='fast'        # use when LOAD_POINTCLOUD is true
# DIFFUSION_STEPS=100
# ACTION_TOKENIZER_EXIST=true  # if you dont want to use AR loss, set it to false
# USE_DIFF=true
# AR_DIFF_LOSS=true            # if you dont want to use AR loss, set it to false
# REPEATED_DIFFUSION_STEPS=4
# CLASS_DROPOUT_PROB=0.0
# FREEZE_VISON=false
# FREEZE_LLM=false
# SLOW_FAST_RATIO=1_4
# ACTION_CHUNK=1
# LANG_SUBGOALS_EXIST=true

# SETTING="test_multi_key_STATE_${LOAD_STATE}_ACTION_CHUNK_${ACTION_CHUNK}_SLOW_FAST_RATIO_${SLOW_FAST_RATIO}_ddim${DIFFUSION_STEPS}_PC${LOAD_POINTCLOUD}_POS${POINTCLOUD_POS}_${TRAINING_MODE}_withARloss${LOAD_POINTCLOUD}_slow_fast_[after]_[-1]_${LLM_MIDDLE_LAYER}_fisvla_pretrain_window${FUTURE_ACTION_STEPS}"

# DATA_MIX=UAVDataset
# TASK=uav_dataset
# BATCH_SIZE=6
# EPOCHS=1
# LEARNING_RATE=2e-5
# ACTION_DIM=6
# CAMERA_VIEW="head_slow,head_fast"


# DATA_ROOT="/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/datasets/rlds_data"
# EXP_ROOT=/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow/exp
# MODEL_SAVE_NUM=3

# NUM_GPUS=7
# NODES=1
# MASTER_ADDR="127.0.0.1"
# NODE_RANK=0

# # 创建日志目录
# LOG_DIR="/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/Fast-in-Slow/logs"
# mkdir -p ${LOG_DIR}

# # 生成简洁的日志文件名
# LOG_FILE="${LOG_DIR}/train_${TASK}_STATE${LOAD_STATE}_PC${LOAD_POINTCLOUD}_ddim${DIFFUSION_STEPS}_$(date '+%m%d_%H%M').log"

# echo "训练日志将保存到: ${LOG_FILE}"
# echo "开始训练..."

# torchrun --standalone --nnodes=$NODES --nproc-per-node=$NUM_GPUS --node_rank=$NODE_RANK --master_addr=${MASTER_ADDR} --master_port=29500 scripts/train.py \
#   --vla.type prism-dinosiglip-224px+oxe+diffusion \
#   --vla.data_mix ${DATA_MIX} \
#   --vla.base_vlm prism-dinosiglip-224px+7b \
#   --need_to_sub 0 \
#   --vla.expected_world_size $((${NUM_GPUS} * ${NODES})) \
#   --vla.per_device_batch_size ${BATCH_SIZE} \
#   --vla.global_batch_size $((${NUM_GPUS} * ${NODES} * ${BATCH_SIZE})) \
#   --vla.learning_rate ${LEARNING_RATE} \
#   --vla.epochs ${EPOCHS} \
#   --vla.freeze_vision_backbone ${FREEZE_VISON} \
#   --vla.freeze_llm_backbone ${FREEZE_LLM} \
#   --data_root_dir ${DATA_ROOT}/${TASK} \
#   --run_root_dir ${EXP_ROOT} \
#   --run_id exp_${TASK}_${SETTING} \
#   --image_aug false \
#   --wandb_project '<wandb_project>' \
#   --wandb_entity '<wandb_entity>' \
#   --save_interval 100 \
#   --action_dim ${ACTION_DIM} \
#   --repeated_diffusion_steps ${REPEATED_DIFFUSION_STEPS} \
#   --action_tokenizer_exist ${ACTION_TOKENIZER_EXIST} \
#   --future_action_window_size ${FUTURE_ACTION_STEPS} \
#   --class_dropout_prob ${CLASS_DROPOUT_PROB} \
#   --use_diff ${USE_DIFF} \
#   --ar_diff_loss ${AR_DIFF_LOSS} \
#   --is_resume False \
#   --llm_middle_layer ${LLM_MIDDLE_LAYER} \
#   --camera_view ${CAMERA_VIEW} \
#   --training_mode ${TRAINING_MODE} \
#   --load_pointcloud ${LOAD_POINTCLOUD} \
#   --diffusion_steps ${DIFFUSION_STEPS} \
#   --model_save_num ${MODEL_SAVE_NUM} \
#   --pointcloud_pos ${POINTCLOUD_POS} \
#   --action_chunk ${ACTION_CHUNK} \
#   --load_state ${LOAD_STATE} \
#   --lang_subgoals_exist ${LANG_SUBGOALS_EXIST} \
#   --pretrained_checkpoint "/home/gentoo/docker_shared/asus/liusq/UAV_VLN/vln_proj/ckpts/models--haosad--fisvla" 2>&1 | tee -a ${LOG_FILE}

# echo "训练完成！日志文件: ${LOG_FILE}"